<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ca">

<body>

<!-- EDITOR HTML -->
<div th:fragment="htmlEditor" class="col-md-8 d-flex flex-column"
     style="max-height: 100%; overflow: hidden; max-width: 100%;">
    <div class="card flex-grow-1 h-100" style="border: none; min-height: 0;">
        <div class="card-body d-flex flex-column h-100 p-1">
            <form id="editorForm" class="d-flex flex-column flex-grow-1 h-100" style="min-height: 0;">
                <!-- Camps ocults -->
                <div th:replace="~{taula/fragments/createTemplate/editor :: hiddenFields}"></div>

                <div class="form-group d-flex flex-column flex-grow-1" style="min-height: 0;">
                    <!-- Capçalera de l'editor -->
                    <div th:replace="~{taula/fragments/createTemplate/editor :: editorHeader}"></div>

                    <!-- Textarea -->
                    <textarea class="form-control flex-grow-1"
                              id="htmlContent"
                              name="htmlContent"
                              th:utext="${template != null and template.boxes != null and !template.boxes.isEmpty() ? allBoxesHtml : ''}"
                              placeholder="Introdueix aquí el teu codi HTML..."
                              style="height: 100%; font-size: 0.875rem; min-height: calc(100vh - 300px);"></textarea>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Fragment: Campos Ocults -->
<div th:fragment="hiddenFields">
    <input type="hidden" name="id" th:value="${template != null ? template.id : 1}"/>
    <input type="hidden" id="nomPlantillaHidden" name="name"/>
    <input type="hidden" id="codiPlantillaHidden" name="code"/>
    <input type="hidden" name="boxId"
           th:value="${template != null and template.boxes != null and !template.boxes.isEmpty() ? template.boxes[0].id : null}"/>
    <input type="hidden" name="boxType"
           th:value="${template != null and template.boxes != null and !template.boxes.isEmpty() ? template.boxes[0].boxType : null}"/>
    <input type="hidden" id="stylePlantillaHidden" name="style"/>
    <input type="hidden" id="variablesJson" name="variablesJson"/>
    <input type="hidden" name="styleId"
           th:value="${templateStyle != null ? templateStyle.id : ''}"/>
</div>

<!-- Fragment: Capçalera de l'Editor -->
<div th:fragment="editorHeader" class="d-flex justify-content-between align-items-center mb-2">
    <label for="htmlContent" class="font-weight-bold mb-0">Codi HTML</label>

    <div class="d-flex gap-2">
        <!-- Dropdown funciones -->
        <div th:replace="~{taula/fragments/createTemplate/editor :: functionsDropdown}"></div>

        <!-- Dropdown acciones -->
        <div th:replace="~{taula/fragments/createTemplate/editor :: actionsDropdown}"></div>
    </div>
</div>

<!-- Fragment: Dropdown Funciones -->
<div th:fragment="functionsDropdown" class="dropdown">
    <button data-toggle="dropdown"
            class="btn btn-sm mr-1 btn-primary dropdown-toggle"
            type="button"
            id="functionDropdown"
            aria-haspopup="true"
            aria-expanded="false">
        <i class="fa fa-code mr-1"></i> Afegir funció
    </button>
    <div class="dropdown-menu dropdown-menu-right" aria-labelledby="functionDropdown">
        <a th:each="func : ${functions}"
           class="dropdown-item function-item"
           href="#"
           th:attr="data-html-text=${func.htmlText}">
            <i class="fa fa-code mr-2"></i>
            <span th:text="${func.name}">Function Name</span>
        </a>
    </div>
</div>

<!-- Fragment: Dropdown Acciones -->
<div th:fragment="actionsDropdown" class="dropdown">
    <button data-toggle="dropdown" class="btn btn-sm btn-success dropdown-toggle">
        <i class="fa fa-wrench"></i> Accions
    </button>
    <ul class="dropdown-menu dropdown-menu-right">
        <li>
            <a th:if="${template != null}"
               th:href="@{/templates/show/{id}(id=${template.id})}"
               class="dropdown-item text-dark"
               title="Previsualitzar">
                <i class="fa fa-eye fa-fw text-warning"></i> Previsualitzar
            </a>
        </li>
        <li>
            <a href="#" class="dropdown-item text-dark"
               data-toggle="modal" data-target="#styleModal">
                <i class="fa fa-paint-brush fa-fw text-success"></i> Associar estil
            </a>
        </li>
        <li>
            <a href="#" class="dropdown-item text-dark"
               data-toggle="modal" data-target="#propietatsModal">
                <i class="fa fa-info-circle fa-fw text-info"></i> Propietats
            </a>
        </li>
        <li>
            <a href="#" class="dropdown-item text-dark"
               data-toggle="modal" data-target="#configModal">
                <i class="fa fa-cog fa-fw text-secondary"></i> Configuració
            </a>
        </li>
        <li>
            <a href="#" class="dropdown-item text-dark"
               th:attr="data-id=${template.id}, data-code=${template.code}"
               onclick="handleExportClick(this)"
               th:if="${template != null}">
                <i class="fa fa-arrow-down fa-fw text-dark"></i> Exportar plantilla
            </a>
        </li>
        <li>
            <a href="#" class="dropdown-item text-dark"
               th:onclick="'deleteTemplate(' + ${template.id} + ')'"
               th:if="${template != null}">
                <i class="fa fa-trash fa-fw text-danger"></i> Eliminar plantilla
            </a>
        </li>
        <li class="dropdown-divider"></li>
        <li>
            <a href="#" class="dropdown-item text-dark"
               data-toggle="modal" data-target="#saveModal">
                <i class="fa fa-save fa-fw text-navy"></i> Desar
            </a>
        </li>
    </ul>
</div>

</body>
</html>
